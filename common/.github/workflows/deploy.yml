name: 'Build & Deploy - Config Driven'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      force_rebuild:
        description: 'Force rebuild all services'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: thehunterregistry.azurecr.io
  IMAGE_PREFIX: the-hunter

jobs:
  # Job 1: Detect changed services from devconfig
  detect-changes:
    name: Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      services-matrix: ${{ steps.matrix.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for change detection

      - name: Detect file changes
        id: changes
        run: |
          # Backend changes
          if git diff origin/main...HEAD --quiet -- 'TheHunter/backend/' '.github/workflows/' || [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi
          
          # Frontend changes
          if git diff origin/main...HEAD --quiet -- 'TheHunter/frontend/' '.github/workflows/' || [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

      - name: Create build matrix
        id: matrix
        run: |
          services=$(cat <<'EOF'
          {
            "service": ["backend", "frontend"],
            "include": [
              {"service": "backend", "context": "TheHunter/backend", "image": "the-hunter-api"},
              {"service": "frontend", "context": "TheHunter/frontend", "image": "the-hunter-frontend"}
            ]
          }
          EOF
          )
          echo "services=$services" >> $GITHUB_OUTPUT

  # Job 2: Run tests for changed services
  test:
    name: Test - ${{ matrix.service }}
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up backend environment
        if: matrix.service == 'backend'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'TheHunter/backend/requirements.txt'

      - name: Install backend dependencies
        if: matrix.service == 'backend'
        run: |
          cd TheHunter/backend
          pip install -r requirements.txt

      - name: Run backend tests
        if: matrix.service == 'backend'
        run: |
          cd TheHunter/backend
          pytest tests/ -v --cov=app --cov-report=xml

      - name: Upload backend coverage
        if: matrix.service == 'backend'
        uses: codecov/codecov-action@v3
        with:
          files: ./TheHunter/backend/coverage.xml
          flags: backend

      - name: Set up frontend environment
        if: matrix.service == 'frontend'
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'TheHunter/frontend/package.json'

      - name: Install frontend dependencies
        if: matrix.service == 'frontend'
        run: |
          cd TheHunter/frontend
          npm ci

      - name: Run frontend tests
        if: matrix.service == 'frontend'
        run: |
          cd TheHunter/frontend
          npm run test:ci

      - name: Upload frontend coverage
        if: matrix.service == 'frontend'
        uses: codecov/codecov-action@v3
        with:
          files: ./TheHunter/frontend/coverage/coverage-summary.json
          flags: frontend

  # Job 3: Code quality checks for changed services
  quality:
    name: Quality - ${{ matrix.service }}
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup backend quality checks
        if: matrix.service == 'backend'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'TheHunter/backend/requirements.txt'

      - name: Install backend dependencies
        if: matrix.service == 'backend'
        run: |
          cd TheHunter/backend
          pip install -r requirements.txt
          pip install flake8 pylint

      - name: Lint backend
        if: matrix.service == 'backend'
        run: |
          cd TheHunter/backend
          flake8 app/ --max-line-length=120 --ignore=E501,W503
          pylint app/ --disable=missing-docstring

      - name: Setup frontend quality checks
        if: matrix.service == 'frontend'
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'TheHunter/frontend/package.json'

      - name: Install frontend dependencies
        if: matrix.service == 'frontend'
        run: |
          cd TheHunter/frontend
          npm ci

      - name: Lint frontend
        if: matrix.service == 'frontend'
        run: |
          cd TheHunter/frontend
          npm run lint
          npm run format:check

  # Job 4: Build Docker images for changed services only
  build:
    name: Build - ${{ matrix.service }}
    needs: [detect-changes, test, quality]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.services-matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if service changed
        id: check-change
        env:
          BACKEND_CHANGED: ${{ needs.detect-changes.outputs.backend-changed }}
          FRONTEND_CHANGED: ${{ needs.detect-changes.outputs.frontend-changed }}
        run: |
          if [ "${{ matrix.service }}" = "backend" ] && [ "$BACKEND_CHANGED" = "true" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.service }}" = "frontend" ] && [ "$FRONTEND_CHANGED" = "true" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.check-change.outputs.should-build == 'true'
        uses: docker/setup-buildx-action@v2

      - name: Log in to Azure Container Registry
        if: steps.check-change.outputs.should-build == 'true'
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: Extract metadata
        if: steps.check-change.outputs.should-build == 'true'
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest
            type=raw,value=${{ github.run_number }}

      - name: Build and push Docker image
        if: steps.check-change.outputs.should-build == 'true'
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.context }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:buildcache,mode=max

      - name: Skip build (no changes)
        if: steps.check-change.outputs.should-build == 'false'
        run: |
          echo "⏭️  Skipping build for ${{ matrix.service }} (no changes detected)"

  # Job 5: Deploy to target environment
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    needs: [detect-changes, build]
    if: success()
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy services
        id: deploy
        run: |
          ENVIRONMENT=${{ github.event.inputs.environment }}
          RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
          
          echo "Deploying to $ENVIRONMENT environment..."
          echo "Resource Group: $RESOURCE_GROUP"
          
          # Backend deployment
          if [ "${{ needs.detect-changes.outputs.backend-changed }}" = "true" ]; then
            echo "Deploying backend service..."
            # Azure CLI commands for backend deployment
            az containerapp create-or-update \
              --name the-hunter-api-$ENVIRONMENT \
              --resource-group $RESOURCE_GROUP \
              --image ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest \
              --environment-variables API_BASE_URL=api.thehunter.com
          fi
          
          # Frontend deployment
          if [ "${{ needs.detect-changes.outputs.frontend-changed }}" = "true" ]; then
            echo "Deploying frontend service..."
            # Azure CLI commands for frontend deployment
            az containerapp create-or-update \
              --name the-hunter-frontend-$ENVIRONMENT \
              --resource-group $RESOURCE_GROUP \
              --image ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
          fi
          
          echo "url=https://the-hunter-$ENVIRONMENT.azurewebsites.net" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          echo "Running health checks..."
          sleep 10
          
          # Check API health
          if curl -f -s http://the-hunter-api-staging.azurewebsites.net/api/v1/calculator/health; then
            echo "✅ API health check passed"
          else
            echo "❌ API health check failed"
            exit 1
          fi
          
          # Check frontend health
          if curl -f -s http://the-hunter-staging.azurewebsites.net/ > /dev/null; then
            echo "✅ Frontend health check passed"
          else
            echo "❌ Frontend health check failed"
            exit 1
          fi

  # Job 6: Notifications
  notify:
    name: Send Notifications
    needs: [deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "status=✅ Deployment successful to ${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=❌ Deployment failed to ${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "${{ steps.status.outputs.status }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Environment",
                      "value": "${{ github.event.inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                      "short": true
                    }
                  ]
                }
              ]
            }
